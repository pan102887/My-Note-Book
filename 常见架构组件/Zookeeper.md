# ZooKeeper

## 1. ZooKeeper简介

ZooKeeper是一个开源的分布式协调服务，最初由雅虎研究院开发，后来成为Apache基金会的顶级项目。它提供了一系列简单的原语，分布式应用可以基于这些原语实现更高级的服务，如同步、配置维护、分组和命名等。

### 1.1 核心定位与特性

ZooKeeper的设计目标是提供高性能、高可用、严格顺序访问的协调服务。其核心特性包括：

- **简单的数据模型**：类似于文件系统的层次命名空间，每个节点（ZNode）可以存储数据和拥有子节点
- **可靠性**：即使系统中部分节点失效，ZooKeeper仍能继续服务
- **顺序一致性**：客户端的更新请求按发送顺序应用
- **原子性**：更新操作要么成功要么失败，没有中间状态
- **及时性**：系统保证客户端在一定时间内看到最新数据
- **实时通知**：客户端可以在数据变更时收到通知

### 1.2 典型应用场景

ZooKeeper在分布式系统中被广泛应用于：

1. **配置管理**：集中管理配置，动态更新各节点配置信息
2. **服务发现**：帮助服务消费者找到可用的服务提供者
3. **分布式锁**：实现分布式互斥锁和共享锁
4. **集群管理**：监控集群中机器状态，选举master
5. **分布式队列**：实现FIFO队列、屏障等高级同步原语
6. **命名服务**：为分布式系统中的资源提供全局唯一名称

### 1.3 架构设计

ZooKeeper采用集群模式部署，通常由奇数个节点组成，典型配置为3、5或7个节点。其核心架构包括：

- **Leader**：处理写请求，调度并决定变更顺序
- **Follower**：处理读请求，参与投票选举
- **Observer**（可选）：只处理读请求，不参与投票，用于提高读性能
- **ZAB协议**（ZooKeeper Atomic Broadcast）：保证分布式事务的顺序一致性

ZooKeeper集群作为一个整体对外提供服务，客户端可连接到任一节点。集群中超过半数节点存活，服务即可用（满足CAP理论中的CP特性）。

### 1.4 数据模型

ZooKeeper的数据存储结构类似于标准文件系统：

- **ZNode**：数据节点，每个节点可存储最大1MB数据
- **节点类型**：
  - **持久节点**：除非主动删除，否则一直存在
  - **临时节点**：与客户端会话绑定，会话结束自动删除
  - **顺序节点**：自动添加递增序号后缀
  - **容器节点**（3.5.3版本后）：当最后一个子节点被删除后自动清理

每个ZNode都维护一个**状态结构（Stat）**，记录版本号、ACL信息、时间戳等元数据。

### 1.5 会话与监听机制

- **会话（Session）**：客户端与服务端的连接，通过心跳维持
- **监视器（Watcher）**：一种订阅-通知模式，客户端可监听数据变化并接收通知
- **ACL（Access Control List）**：类似UNIX文件权限，控制节点访问权限

ZooKeeper以其高性能（10K+/秒读取）和简洁设计，成为构建可靠分布式应用的基础组件，被Hadoop、Kafka、HBase等众多开源项目广泛采用。


## 2. ZooKeeper工作原理

ZooKeeper的工作原理涉及其内部实现机制、一致性协议及数据同步过程。理解这些原理有助于更好地设计和使用ZooKeeper来构建可靠的分布式系统。

### 2.1 ZAB协议详解

**ZAB协议**（ZooKeeper Atomic Broadcast，ZooKeeper原子广播协议）是ZooKeeper实现一致性的核心协议，它包括以下两种模式：

1. **崩溃恢复模式（Recovery）**：当Leader节点崩溃或者Leader失去与过半Follower的连接时，ZAB协议进入崩溃恢复模式，选举产生新的Leader。

2. **消息广播模式（Broadcast）**：当集群中已经有过半的Follower完成与Leader的状态同步后，ZAB协议进入消息广播模式，Leader接收客户端的请求，并将请求作为提案（Proposal）广播给所有Follower。

ZAB协议的工作流程遵循以下步骤：

- **Leader选举**：通过Fast Leader Election（FLE）算法，选出拥有最高zxid（事务ID）的节点作为Leader
- **数据同步**：新Leader与Follower完成数据同步，确保系统中所有节点的数据一致
- **消息广播**：Leader将所有的写请求转换为事务，并按顺序广播给所有Follower
- **持久化与应用**：节点将事务写入本地事务日志并应用到内存数据库中

### 2.2 请求处理流程

ZooKeeper中的请求处理分为读请求和写请求两种：

#### 读请求处理

读请求可以由任意服务器直接处理：

1. 客户端发送读请求到任一ZooKeeper服务器
2. 服务器从内存数据库中查询数据
3. 返回结果给客户端

#### 写请求处理

写请求必须由Leader协调处理：

1. 客户端发送写请求到任一ZooKeeper服务器
2. 若接收服务器是Follower，则转发请求给Leader
3. Leader为写请求生成全局唯一的事务ID（zxid）
4. Leader向所有Follower发送提案（Proposal）
5. Follower收到提案后，写入到事务日志
6. Follower向Leader发送ACK确认
7. Leader收到超过半数的ACK后，向所有Follower发送COMMIT消息
8. Follower收到COMMIT后，将变更应用到内存数据库
9. 服务器返回处理结果给客户端

### 2.3 数据一致性保证

ZooKeeper确保数据一致性的关键机制包括：

- **过半数投票机制**：任何事务必须获得过半数节点的确认
- **单一主节点**：所有写操作由Leader统一协调
- **全局递增事务ID**：每个写操作分配唯一且递增的zxid，确保操作顺序
- **完全有序性**：保证所有服务器按相同顺序应用所有事务

ZooKeeper提供以下几种一致性保证：

- **顺序一致性**：客户端的更新请求按照发送顺序被处理
- **原子性**：更新操作要么成功要么失败，不会部分应用
- **单一系统映像**：无论客户端连接到哪个服务器，看到的数据视图是一致的
- **持久性**：一旦更新操作被应用，其效果将持久保存直到被覆盖

### 2.4 Leader选举

ZooKeeper使用Fast Leader Election（FLE）算法进行Leader选举，选举过程如下：

1. **启动选举**：当集群初始化或Leader崩溃时，进入选举状态
2. **投票阶段**：
   - 每个服务器投票给自己，投票包含(myid, zxid)
   - 服务器收到其他投票后，对比zxid和myid
   - 优先选择zxid最大的服务器；如果zxid相同，选择myid最大的
   - 更新自己的投票并发送给其他服务器
3. **选举完成**：当某个服务器收到过半数相同投票后，该服务器被选举为Leader
4. **状态同步**：新Leader与Follower进行状态同步

### 2.5 会话管理

ZooKeeper的会话管理包括：

- **会话创建**：客户端连接服务器，创建会话，获得sessionID
- **会话激活**：客户端定期向服务器发送心跳包来保持会话活跃
- **会话过期**：如果在超时时间内没有收到心跳，会话被视为过期
- **会话清理**：过期会话被清理，关联的临时节点被删除

### 2.6 监视器（Watcher）机制

ZooKeeper的Watcher机制工作原理：

1. 客户端在读取数据时注册Watcher
2. 服务器将Watcher对象存储在本地WatchManager中
3. 当数据变更时，服务器通知相关的Watcher
4. 客户端收到通知，执行回调
5. Watcher是一次性触发的，触发后即被移除

Watcher特点：

- **轻量**：仅通知变化类型，不包含具体数据
- **一次性**：触发后自动删除，需要重新注册
- **可靠顺序**：客户端先得到Watcher通知，再看到新数据

ZooKeeper通过上述机制，实现了高可用、高性能的分布式协调服务，为构建复杂的分布式系统提供了坚实基础。

## 3. ZooKeeper实际应用