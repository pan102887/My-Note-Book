# 1. 商品限购逻辑  

- [1. 商品限购逻辑](#1-商品限购逻辑)
  - [1.1. groupCode级限购](#11-groupcode级限购)
    - [1.1.1. XPILOT 限购逻辑](#111-xpilot-限购逻辑)
    - [1.1.2. RIGHTS_PACK 权益商品限购逻辑](#112-rights_pack-权益商品限购逻辑)
    - [1.1.3. COUPON 售后代金券限购逻辑](#113-coupon-售后代金券限购逻辑)
    - [1.1.4. HOTEL_RESERVATION 酒店商品限购逻辑](#114-hotel_reservation-酒店商品限购逻辑)
    - [1.1.5. RESERVATION_PLATFORM 预约中台限购逻辑](#115-reservation_platform-预约中台限购逻辑)
    - [限购商品列表按groupCode分类](#限购商品列表按groupcode分类)

商品的限购逻辑有groupCode级限购, skuCode特定限购，以下针对groupCode限购内容展开

## 1.1. groupCode级限购  

其中附加贷支付类型（支付中心回调）类型没有groupCode级限购。  

groupCode级限购会根据不同的spuGroup，走不同的限购逻辑，目前已有的spuGroup以及对应的限购接口分别有  

| spuGroup             | 备注       | 相关接口                            |
| -------------------- | ---------- | ----------------------------------- |
| XPILOT               | XP 3.0     | xpilotGroupServiceImpl              |
| RIGHTS_PACK          | 权益中心   | equityGroupServiceImpl              |
| COUPON               | 售后代金券 | couponGroupServiceImpl              |
| HOTEL_RESERVATION    | 酒店订单   | hotelOrderGroupServiceImpl          |
| RESERVATION_PLATFORM | 预约中台   | reservationPlatformGroupServiceImpl |

### 1.1.1. XPILOT 限购逻辑

不同的XPILOT 版本有不同的限购逻辑，但都是主要根据skuCode进行区分。以下逻辑按代码执行顺序展示，以下将XPILOT简称为XP，

- 15天授权版本的P7 XP3.0：此版本的XP3.0，必须在尚未购买终身版 P7 XP3.0 的情况下（没有在途或已完成终身版订单），才允许购买。若已购买终身版则不允许购买，并在下单时提示“已购买终身版服务 ${skuCode}”，。否则进行放行，允许购买，若非此版本的XP商品的订单，则继续执行以下逻辑。

- 限购skuCode列表：商城侧的限购配置项中有维护一个限购的skuCode名单，对于不在限购名单中的skuCode则会进行放行。若命中此skuCode列表，则继续执行以下的限购校验逻辑。
  
- 白名单校验：若用户在白名单列表中，则会进行白名单校验。白名单给指出对应用户不限购的商品skuCode，以及对应的限购数量。若白名单用户的在途和已完成的订单数量小于白名单的限购数量，则进行放行。若白名单用户购买的商品超出白名单限购数量限制，则不允许购买，并提示"存在{}个在途/已完成订单,这次要买{}个，白名单限购{}个"。若不是白名单用户，则继续执行以下逻辑。

- 整车订单信息校验：XP软件订单由整车跳转进入商城，则会在预交易单中附加上整车订单的信息。若整车订单信息为空，则认为此订单不是由正常路径进入（整车跳转），则不允许购买，并提示"不是从整车入口进入不允许购买"。否则继续执行以下逻辑。

- 鹏派测数量限购：一辆车限购一辆，订单中购买数量若不是1，则校验不同过，并提示"购买数量不正确，一辆车只能买一个"  

- 整车限购校验（外部）：调用"/logan/xpilot/xpilotPurchaseCheck"接口，传入uid，整车订单号，skuCode进行查询，若接口返回数据为空则校验不通过，不允许购买。  

- 若同一个orsId下有其他在途/已完成订单，则不允许购买，并提示"存在在途/已完成订单{订单号}"  

### 1.1.2. RIGHTS_PACK 权益商品限购逻辑  

权益中心商品的商品限购校验由权益中心提供，鹏派使用相关信息查询权益的校验接口。由权益中心的返回结果告知是否允许用户购买。  

- 权益boot: xp-equity-svr-boot
- 接口路径: /logan/order/preCheck  
- 参数: spuCode, skuCode, uid, vin码

查询权益限购接口用到的参数有：spuCode, skuCode, uid, vin码。但有一点值得注意：在权益侧，他们将我们的 spuCode和 skuCode称为 spuId与 skuId。

若购买权益商品时，没有传入vin码，则在商城侧提前拦截，并展示"没有绑定vin码, 不能购买"  

若权益接口返回为空数据，则不允许购买，并抛出权益中心服务异常

若权益接口返回码为：23000215，代表未绑定车辆主使用人，不允许购买。

若权益返回数据中表示不允许购买，抛出没有下单资格异常，默认展示文本为"车辆不符合条件，无法购买。"  

### 1.1.3. COUPON 售后代金券限购逻辑  

暂无

### 1.1.4. HOTEL_RESERVATION 酒店商品限购逻辑  

暂无

### 1.1.5. RESERVATION_PLATFORM 预约中台限购逻辑  

由预约中心限购检查接口提供限制检查逻辑  

- bootName: xp-booking-boot  
- 接口路径: /logan/booking/order/orderPreCheck  
- 参数: spuCode, skuCode, uid, sku购买数量  

若接口返回为空，则抛出预约中心服务异常

若返回状态码为非0，则抛出没有下单资格异常: “暂不支持购买”  

### 限购商品列表按groupCode分类  

1. XPILOT
   1. XPILOT_30 XPilot软件包  

2. RIGHTS_PACK  
   1. RIGHTS_PACK 组合包-短期服务  
   2. RIGHTS_PACK_LONG_TERM 组合包-长期服务  
   3. WASH_COUPON 单一产品-一次性  
   4. RIGHTS_UNLIMITED 单一产品-不限次数  
   5. BATTERY_LIFE_INSURANCE 电池终生质保  
   6. ELECTRIC_LIFE_INSURANCE 电机终生质保
   7. CAR_INSURANCE 延保  
   8. VEHICLE_WARRANTY 整车质保  
   9. ENTERTAINMENT_PACK 娱乐包
   10. CHARGECARD 充电折扣卡
