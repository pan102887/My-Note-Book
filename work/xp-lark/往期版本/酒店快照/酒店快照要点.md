# 酒店快照
## 改动设计
### 新增模型
1. spu_hotel_snapshot
    ```sql
    create table spu_hotel_snapshot
    (
        id                    bigint unsigned auto_increment comment '自增主键'
            primary key,
        spu_hotel_snapshot_id varchar(64) default ''                not null comment '业务主键',
        spu_id                varchar(64) default ''                not null comment '关联的spuId',
        hotel_address         json                                  not null comment '酒店地址信息',
        check_in_time         time        default '14:00:00'        not null comment '登记入住时间',
        check_out_time        time        default '12:00:00'        not null comment '最晚离开时间',
        hotel_phone           varchar(32) default ''                not null comment '酒店联系电话',
        create_time           datetime    default CURRENT_TIMESTAMP not null comment '创建时间',
        create_uid            varchar(32) default ''                not null comment '创建人',
        update_time           datetime    default CURRENT_TIMESTAMP not null comment '更新时间',
        update_uid            varchar(32) default ''                not null comment '更新人',
        is_delete             tinyint(2)  default 2                 not null comment '是否已删除 | 1 已删除 2未删除',
        version               bigint      default 1                 not null comment '版本号',
        constraint uk_spu_hotel_snapshot_id
            unique (spu_hotel_snapshot_id)
    )
        comment '酒店商品附加快照表';
    create index idx_spu_id_version
        on spu_hotel_snapshot (spu_id, version);
    ```
2. sku_hotel_snapshot
    ```sql
    create table sku_hotel_snapshot
    (
        id                    bigint unsigned   auto_increment comment '自增主键'
            primary key,
        sku_hotel_snapshot_id varchar   (64)                           not null comment '  业务主键',
        sku_id                varchar   (64)                           not null comment '  关联的skuId',
        room_imgs               json                                  not null    comment '房型展示图',
        detail_imgs             json                                  not null    comment '介绍图片',
        create_time           datetime    default   CURRENT_TIMESTAMP not null comment '创建时间',
        create_uid            varchar(32) default   ''                not null comment '创建人',
        update_time           datetime    default   CURRENT_TIMESTAMP not null comment '更新时间',
        update_uid            varchar(32) default   ''                not null comment '更新人',
        is_delete             tinyint(2)  default   2                 not null comment '删除标志位| 2：   未删除， 1：已删除',
        version               bigint      default   1                 not null comment '版本号',
    constraint uk_sku_hotel_snapshot_id
        unique (sku_hotel_snapshot_id)
    )
        comment '酒店商品sku附加快照表';
    create index idx_sku_id_version
        on sku_hotel_snapshot (sku_id, version);
    ```

### 现有模型改动
1. sku_hotel
   ```sql
   alter table sku_hotel add version bigint default 1 not null comment 'sku_hotel版本号';
   ```
2. spu_hotel
   ```sql
   alter table spu_hotel add version bigint default 1 not null comment 'spu_hotel版本号';
   ```
3. order_hotel_info
    ```sql
    <!-- alter table order_hotel_info add spu_version        bigint              default 1  not null comment '关联的spu的版本号'; -->
    <!-- alter table order_hotel_info add sku_version        bigint              default 1  not null comment '关联的sku的版本号'; -->
    alter table order_hotel_info add spu_hotel_version  bigint              default 1  not null comment '关联的spu_hotel的版本号';
    alter table order_hotel_info add sku_hotel_version  bigint              default 1  not null comment '关联的sku_hotel的版本号';
    ```
4. 旧数据写入
   ```sql
   slect
   ```
### 新增类
1. SpuHotelSnapshot.java -- package com.xiaopeng.xplarkgoods.boot.pojo.entity.hotel  
   spu_hotel_snapshot的实体类
2. SpuHotelSnapshotQueryParam -- com.xiaopeng.xplarkgoods.service.pojo.param  
   spu_hotel_snapshot的查询参数
3. SpuHotelSnapshotListQueryParam -- com.xiaopeng.xplarkgoods.service.pojo.param  
   spu_hotel_snapshot的批量查询参数  
---
4. SkuHotelSnapshot.java -- package com.xiaopeng.xplarkgoods.boot.pojo.entity.hotel  
   sku_hotel_snapshot的实体类  
5. SkuHotelSnapshotQueryParam -- com.xiaopeng.xplarkgoods.service.pojo.param  
   sku_hotel_snapshot的查询参数  
6. SkuHotelSnapshotListQueryParam -- com.xiaopeng.xplarkgoods.service.pojo.param  
   sku_hotel_snapshot的批量查询参数  

--- 
7. SpuHotelSnapshotDao -- com.xiaopeng.xplarkgoods.boot.dao.hotel  
   spu_hotel_snapshot的Dao层，实现的功能有  
   1. getByIdAndVersion：根据spu_hotel_snapshot的version,spu_id查询spu_hotel_snapshot的记录   
   2. pageList：根据批量查询参数，分页返回spu_hotel_snapshot查询结果  
   3. getBatchByIdAndVersion: 根据批量查询参数，使用列表返回spu_hotel_snapshot查询结果   

8. SkuHotelSnapshotDao -- com.xiaopeng.xplarkgoods.boot.dao.hotel  
   sku_hotel_snapshot的Dao层，实现的功能有  
   1. getByIdAndVersion：根据sku_hotel_snapshot的version,spu_id查询sku_hotel_snapshot的记录   
   2. pageList：根据批量查询参数，分页返回sku_hotel_snapshot查询结果  
   3. getBatchByIdAndVersion: 根据批量查询参数，使用列表返回sku_hotel_snapshot查询结果  

---  
9. HotelDetailSnapshotQueryParam -- com.xiaopeng.xplarkgoods.service.pojo.param
    酒店快照查询参数，用于查询spu_snapshot,spu_detail_snapshot,spu_hotel_snapshot这三张表
10. HotelSnapshotService.java -- com.xiaopeng.xplarkgoods.boot.service.hotel
    酒店快照相关服务，功能有
    1. 查询酒店相关信息快照

### 修改类
1. HotelInfoDto -- com.xiaopeng.xplarkorder.service.pojo.dto  
   改动点：新增version字段,对应spu_hotel
   ```java
    /**
     * 版本号
     */
    private Long version;
   ```

### 版本号跟踪
1. 在创建交易单时，查询预交易单的过程（获取预订单），会根据预交易单中的spuId和skuId，将商品信息补全（从数据库中查询），包括版本号。
2. 在创建订单的过程中，核心过程的handlBusi中，packOrderSplitMaterialParam过程中，将预交易单查询结果
3. 酒店sku信息链路
   1. PreTradeServiceImpl.getPreTradWithGoodInfo.getGoodsAndTargetSkuByPreTrade
   2. splitMaterialParam.getMaterial().getGoodsInfoList()

### 交易单的创建流程
1. 查询预交易单，并进行数据合法性校验，将商品信息根据spuId,skuId补全。结合交易单创建参数生成交易单实体，并写入数据库
2. 更新预交易单，预交易单绑定订单号
3. 进行优惠券部分逻辑处理（可回滚）
4. 积分部分逻辑（可回滚）
5. 库存扣减（可回滚）
6. 销量增加（可回滚）
7. **`创建订单`**
8. 