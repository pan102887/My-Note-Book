# 用户触达概要设计

## 需求分析

1. 希望将push统一放到一个池子中进行统一管理。对派发的历史进行记录，池子中的模板可以灵活创建。
2. 新增主动派发逻辑，可以根据一定规则（用户群体，发送时间等），主动推送app push内容。（场景一）
3. 将之前分散在优惠券，支付有礼等各部分的app push逻辑收归进入push服务，便于记录推送日志，以及对优惠券、支付有礼的推送内容进行灵活切换。（场景二）

## 细节

1. 主动派发任务细节
   1. 用户群体
      1. 可以根据dmp返回的用户标签进行用户群体的灵活选择。
      2. 手动导入UID
2. 支付有礼、优惠券包等固定场景推送细节

## 分析

推送内容与目标用户是构成`推送任务`的必要信息。决定了将什么内容推送给谁。

`推送任务`的必要信息则由`推送动作（runable）`与`执行时间`组成。`推送动作`实现了推送的发送过程，由工厂根据内容模板以及目标用户组装生成。执行时间则规定了推送动作的发生时间点。因此推送任务决定了在什么时间将什么内容发送给谁。

`推送任务工厂`根据`内容模板`和`目标用户`信息以及`规则模板`中所预定的规则生成`推送任务`。生成的推送任务则按照执行时间排序后，放入`任务队列`（小根堆实现）中，由任务执行器按照规定时间执行。

外部服务若需要发送推送，则可以向工厂"下订单"来达到推送发送的目的，其中`"订单"`中需要提供的内容有`内容模板`,`用户列表`,`规则模板`。

`规则模板`则决定推送任务是否应被生产，以及任务执行时间。一种`类型`的规则模板对应工厂的一种`生产模式`。

`任务执行器`通过不断轮询任务列表，将符合条件的推送任务从任务列表中取出并执行。——消费者

以下从业务场景角度分析以上模型的实际应用。

- 固定推送场景  
  例如优惠券，支付有礼等其他业务所触发的推送任务。此类场景中，规则中`是否应该`生产总是为真，`什么时候`执行总为立即执行。因此规则模板在此处并没有对推送任务做出太多限制。`推送订单`到达工厂后，工厂需要立即按照`推送订单`生产相应的推送任务，并由任务执行器尽快执行。

- 手动推送场景
  此类场景如活动推送，营销推送等人工主动派发的场景。
  
  此类场景下，推送被分类为"主动推送"，这里需对用户的`单日最大可收到的"主动推送"数量`做出限制。并且全局有效。

  推送时间可以分为立即执行与定时执行。

  目标用户

## 建模  

1. 上下文-内容模板
   1. 模板唯一标识
   2. 标题 (String)
   3. 正文 (String)
   4. url (String)

2. 上下文-目标用户
   1. 用户ID列表

3. 上下文-规则模板
   1. 类型(定时执行)
   2. 执行时间(定时执行)

4. 上下文-任务工单
   1. 任务工单唯一标识
   2. 内容模板ID
   3. 执行时间
   4. 执行状态（未执行 执行中 已执行）
   5. 用户来源（导入，dmp人群标签）
   6. 单日推送上限

5. 上下文-推送任务
   1. 任务唯一标识
   2. 任务工单标识
   3. 内容模板ID
   4. 目标用户UID
   5. 执行时间 (Date)
   6. 执行状态

6. 功能-工厂
   1. 根据内容模板，目标用户uid列表和任务执行规则生成任务列表

7. 功能-任务队列
   1. 存储待执行或执行中的任务工单对应的任务，并控制器